{% extends "base.html" %}

{% block head %}
    {{ super() }} 
{% endblock %}

{% block content %}
    <!-- "My Workout Week" Section -->
    <header class="posts-header">
        <h1>My Workout Week</h1>
        <p>Your weekly workout schedule (User ID: {{ mock_user_id }}). You can share this plan with another user.</p>
    </header>

    <section class="workout-plan-container">
        {% if my_plans_data %}
            {% for day, exercises in my_plans_data.items() %}
                <div class="day-plan">
                    <h2>{{ day | capitalize }}</h2>
                    {% if exercises %}
                        <ul>
                            {% for exercise in exercises %}
                                <li>
                                    <strong>{{ exercise.name }}</strong> - {{ exercise.sets }} sets x {{ exercise.reps }} reps
                                    (Calories: {{ exercise.calories }})
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Rest day or no plans for today.</p>
                    {% endif %}
                </div>
            {% endfor %}

            <div class="share-plan-action" style="margin-top: 20px; text-align: center;">
                <button class="share-plan-btn" id="sharePlanBtn"><i class="fas fa-share-square"></i> Share This Week's Plan</button>
            </div>
        {% else %}
            <div class="post-placeholder">
                <p>No workout plan found for User ID: {{ mock_user_id }}.</p>
            </div>
        {% endif %}
    </section>

    <hr style="margin: 40px 0;"> <!-- Visual separator -->

    <!-- "Plans Shared With Me" Section -->
    <header class="posts-header">
        <h1>Plans Shared With Me</h1>
        <p>Workout plans shared with recipient: <strong>{{ mock_recipient_identifier }}</strong></p>
    </header>

    <section class="shared-plans-container workout-plan-container">
        {% if sharers_for_dropdown %}
            <div class="shared-plan-selector" style="margin-bottom: 20px;">
                <label for="sharerDropdown" style="margin-right: 10px;">Select a Sharer:</label>
                <select id="sharerDropdown" name="sharerDropdown">
                    <option value="">-- Select a Plan --</option>
                    {% for sharer in sharers_for_dropdown %}
                        <option value="{{ sharer.id }}">{{ sharer.display_text }} (Latest)</option>
                    {% endfor %}
                </select>
            </div>

            <div id="selectedSharedPlanDisplay" class="selected-plan-display-area" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; min-height: 100px; background-color: #fdfdfd;">
                <!-- Selected plan will be rendered here by JavaScript -->
                <p style="color: #757575; text-align: center;">Please select a plan from the dropdown above to view details.</p>
            </div>
        {% else %}
            <div class="post-placeholder">
                <p>No workout plans have been shared with {{ mock_recipient_identifier }} yet.</p>
            </div>
        {% endif %}
    </section>

    <!-- Share Plan Modal -->
    <div id="sharePlanModal" class="modal" style="display: none;"> <!-- Hidden by default -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Workout Plan</h2>
                <button class="close-btn" id="closeShareModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sharePlanForm">
                    <p>You are about to share the entire week's plan for User ID: {{ mock_user_id }}.</p>
                    <div class="form-group">
                        <label for="targetUser">Share with (Enter User ID or Email):</label>
                        <input type="text" id="targetUser" name="targetUser" placeholder="e.g., user2 or user2@example.com" required style="width: 90%; padding: 8px; margin-top: 5px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="sharePlanForm" class="submit-btn" id="submitShareBtn">Confirm Share</button>
                <button type="button" class="cancel-btn" id="cancelShareModalBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Basic Modal Functionality (can be moved to a global JS file later)
        const sharePlanBtn = document.getElementById('sharePlanBtn');
        const sharePlanModal = document.getElementById('sharePlanModal');
        const closeShareModalBtn = document.getElementById('closeShareModalBtn');
        const cancelShareModalBtn = document.getElementById('cancelShareModalBtn');
        const sharePlanForm = document.getElementById('sharePlanForm');
        const submitShareBtn = document.getElementById('submitShareBtn');

        if (sharePlanBtn) {
            sharePlanBtn.onclick = function() {
                sharePlanModal.style.display = 'block';
            }
        }

        if (closeShareModalBtn) {
            closeShareModalBtn.onclick = function() {
                sharePlanModal.style.display = 'none';
            }
        }
        
        if (cancelShareModalBtn) {
            cancelShareModalBtn.onclick = function() {
                sharePlanModal.style.display = 'none';
            }
        }

        window.onclick = function(event) {
            if (event.target == sharePlanModal) {
                sharePlanModal.style.display = 'none';
            }
        }

        if (sharePlanForm) {
            sharePlanForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission
                const targetUser = document.getElementById('targetUser').value;
                // Use tojson filter to ensure mock_user_id is correctly passed to JavaScript
                const sharerUserId = {{ mock_user_id | tojson }};
                console.log('Value of sharerUserId before fetch:', sharerUserId); // Added for debugging
                console.log('Type of sharerUserId before fetch:', typeof sharerUserId); // Added for debugging

                if (!targetUser) {
                    alert('Please enter a target user ID or email.');
                    return;
                }
                
                console.log('Attempting to share plan from sharerUserId:', sharerUserId, 'to targetUser:', targetUser);

                try {
                    const response = await fetch('/api/mock_share_plan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Use the global csrfToken variable defined in base.html
                            'X-CSRFToken': csrfToken 
                        },
                        body: JSON.stringify({
                            targetUser: targetUser,
                            sharerUserId: sharerUserId
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        console.log('Share API call successful:', result);
                        alert(result.message || 'Plan shared successfully (mock operation)!');
                    } else {
                        console.error('Share API call failed:', result);
                        alert('Failed to share plan: ' + (result.error || 'Unknown error: ' + response.status));
                    }
                } catch (error) {
                    console.error('Error during share API call:', error);
                    alert('An error occurred while trying to share the plan. Please check the console for details.');
                }
                
                sharePlanModal.style.display = 'none';
                document.getElementById('targetUser').value = '';
            });
        }

        // --- New JavaScript for Shared Plan Dropdown --- 
        const sharerDropdown = document.getElementById('sharerDropdown');
        const selectedSharedPlanDisplay = document.getElementById('selectedSharedPlanDisplay');
        // Parse the JSON data passed from Flask (ensure it's properly escaped if it contains HTML-like strings, though plan data shouldn't)
        // The |safe filter is important here if the JSON string itself might be misinterpreted by Jinja
        const allLatestPlansData = JSON.parse('{{ latest_plans_data_json | safe }}'); 

        if (sharerDropdown) {
            sharerDropdown.addEventListener('change', function() {
                const selectedSharerId = this.value;
                selectedSharedPlanDisplay.innerHTML = ''; // Clear previous content

                if (selectedSharerId && allLatestPlansData[selectedSharerId]) {
                    const planData = allLatestPlansData[selectedSharerId];
                    
                    let content = `<h4>Plan from User ${planData.sharer_id}</h4>`;
                    content += `<p><small>Shared on: ${planData.shared_at}</small></p>`;

                    if (planData.plan_exists) {
                        for (const day in planData.plan_details) {
                            const exercises = planData.plan_details[day];
                            content += `<div class="day-plan" style="background-color: #f9f9f9; margin-top:15px; padding:10px; border-radius: 5px;">
                                            <h5>${day.charAt(0).toUpperCase() + day.slice(1)}</h5>`;
                            if (exercises && exercises.length > 0) {
                                content += '<ul>';
                                exercises.forEach(exercise => {
                                    content += `<li>
                                                    <strong>${exercise.name}</strong> - ${exercise.sets} sets x ${exercise.reps} reps
                                                    (Calories: ${exercise.calories})
                                                </li>`;
                                });
                                content += '</ul>';
                            } else {
                                content += '<p>Rest day or no plans for today.</p>';
                            }
                            content += '</div>';
                        }
                    } else {
                        content += `<p style="margin-top: 15px; font-style: italic;">The sharer (User ID: ${planData.sharer_id}) currently has no workout plan configured.</p>`;
                    }
                    selectedSharedPlanDisplay.innerHTML = content;
                } else if (selectedSharerId === "") {
                    selectedSharedPlanDisplay.innerHTML = '<p style="color: #757575; text-align: center;">Please select a plan from the dropdown above to view details.</p>';
                } else {
                    selectedSharedPlanDisplay.innerHTML = '<p style="color: #dc3545; text-align: center;">Could not find plan details for the selected sharer.</p>';
                }
            });
        }
    </script>
{% endblock %}